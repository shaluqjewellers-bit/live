<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SHALUQ JEWELLERS – Live Gold & Silver</title>
<link rel="icon" href="logo.png" />

<style>
@font-face{font-family:"ClarityCity";src:url("ClarityCity-Regular.ttf") format("truetype");font-weight:400}
@font-face{font-family:"ClarityCity";src:url("ClarityCity-SemiBold.ttf") format("truetype");font-weight:600}
@font-face{font-family:"ClarityCity";src:url("ClarityCity-Bold.ttf") format("truetype");font-weight:800}

html,body{width:100%;height:100%;margin:0;padding:0;}
:root{
  --bg:#04050a;
  --gold:#ffd36a;
  --gold2:#ffb300;
  --gold3:#fff1c6;
  --open:#26d68a;
  --closed:#ff5c5c;
  --text:#ffffff;
  --muted:#cfd8ff;
  --shadow:0 18px 55px rgba(0,0,0,.65);
  --shadow2:0 0 0 1px rgba(255,211,106,.06), 0 18px 55px rgba(0,0,0,.62);
}

body{
  min-height:100vh;
  background:
    radial-gradient(1200px 600px at 50% 0%, #0b1430 0%, var(--bg) 55%, #02030a 100%),
    radial-gradient(900px 520px at 82% 18%, rgba(255,211,106,.06), transparent 60%);
  color:var(--text);
  font-family:"ClarityCity",Arial,sans-serif;
  overflow-x:hidden;
  overflow-y:auto;
  position:relative;
}

/* micro-noise */
body::after{
  content:"";
  position:fixed; inset:0;
  pointer-events:none; z-index:0;
  opacity:.07; mix-blend-mode:overlay;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
  background-size:140px 140px;
}

/* ambient glow */
body::before{
  content:"";
  position:fixed; inset:-20%;
  pointer-events:none; z-index:0;
  opacity:.26; filter: blur(38px);
  background:
    radial-gradient(900px 420px at 18% 12%, rgba(255,179,0,.18), transparent 62%),
    radial-gradient(1000px 520px at 86% 22%, rgba(255,211,106,.12), transparent 70%),
    radial-gradient(850px 480px at 55% 88%, rgba(255,179,0,.10), transparent 70%);
  animation:ambientGlow 36s ease-in-out infinite;
}
@keyframes ambientGlow{
  0%{transform:translate3d(-1.4%,-1.4%,0) scale(1.02);opacity:.20;}
  50%{transform:translate3d( 1.4%, 1.0%,0) scale(1.06);opacity:.32;}
  100%{transform:translate3d(-1.4%,-1.4%,0) scale(1.02);opacity:.20;}
}

.hero,.divider,.rates,.ticker,.statusbar,.snapshot,.footerline{position:relative;z-index:1;}

/* =========================
   TOP STATUS BAR
   ========================= */
.statusbar{width:100%;display:flex;justify-content:center;padding:10px 12px 0;}
.statusbar-inner{
  width:min(1520px, 96vw);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding:12px 16px;
  border-radius:999px;
  background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
  border:1px solid rgba(255,211,106,.22);
  backdrop-filter: blur(14px);
  box-shadow:0 10px 34px rgba(0,0,0,.55);
  overflow:hidden;
}

.sb-left{display:flex;align-items:center;gap:12px;min-width:0;}
.dot{
  width:14px;height:14px;border-radius:50%;
  background:var(--open);
  box-shadow:0 0 16px var(--open);
  animation:blink 1.6s infinite;
  flex:0 0 auto;
}
@keyframes blink{0%,100%{opacity:.45}50%{opacity:1}}

.sb-title{
  font-weight:900;
  letter-spacing:.25px;
  font-size:20px; /* ✅ bigger */
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.sb-clock{
  text-align:right;
  font-weight:900;color:#eaf0ff;opacity:.98;
  letter-spacing:.25px;white-space:nowrap;
  font-size:18px; /* ✅ bigger */
  flex:0 0 auto;
}

/* MOBILE */
@media (max-width:768px){
  .statusbar{padding-top:58px;}
  .statusbar-inner{
    flex-direction:column;
    align-items:center;
    border-radius:22px;
    padding:10px 12px;
    gap:8px;
  }
  .sb-left{justify-content:center;gap:10px;}
  .sb-title{
    text-align:center;
    white-space:normal;
    line-height:1.25;
    font-size:18px; /* ✅ bigger */
    letter-spacing:.15px;
  }
  .sb-clock{
    text-align:center;
    font-size:16px; /* ✅ bigger */
    white-space:normal;
    line-height:1.25;
  }
}

/* HEADER */
.hero{padding:14px 14px 12px;border-bottom:1px solid rgba(255,179,0,.10);}
.hero-inner{display:flex;justify-content:center;align-items:center;gap:18px;}
.logo-wrap{
  width:92px;height:92px;border-radius:24px;
  display:grid;place-items:center;
  background:linear-gradient(180deg, rgba(12,14,20,.92), rgba(6,8,12,.92));
  border:1px solid rgba(255,211,106,.22);
  box-shadow:var(--shadow2), inset 0 0 18px rgba(255,255,255,.07);
  position:relative;overflow:hidden;
}
.logo-wrap::after{
  content:"";position:absolute;inset:-60%;
  background:linear-gradient(120deg, transparent 38%, rgba(255,255,255,.22) 50%, transparent 62%);
  animation:shine 7.5s infinite;opacity:.75;
}
@keyframes shine{0%{transform:translateX(-120%)}100%{transform:translateX(120%)}}
.logo-wrap img{width:68px;max-width:78%;height:auto;display:block;}

.brand{text-align:center}
.brand-name{
  font-size:54px;font-weight:800;letter-spacing:7px;
  color:transparent;
  background:linear-gradient(90deg,#fff7dc,#ffd36a,#ffffff,#ffb300,#fff7dc);
  background-size:320% 100%;
  background-clip:text;-webkit-background-clip:text;
  text-shadow:0 0 18px rgba(255,179,0,.38), 0 0 42px rgba(255,179,0,.18);
  animation:goldFlow 12s linear infinite;
  position:relative;display:inline-block;overflow:hidden;
}
@keyframes goldFlow{0%{background-position:0%}100%{background-position:320%}}
.brand-sub{
  margin-top:10px;font-size:14px;color:#dce4ff;opacity:.92;
  letter-spacing:2.8px;text-transform:uppercase;
}

.divider{
  height:2px;width:min(1320px, 92vw);
  margin:10px auto 0;border-radius:999px;
  background:linear-gradient(90deg, rgba(255,179,0,0) 0%, rgba(255,211,106,.20) 15%, rgba(255,179,0,.62) 50%, rgba(255,211,106,.20) 85%, rgba(255,179,0,0) 100%);
  box-shadow:0 0 22px rgba(255,179,0,.12);
  opacity:.92;
}

/* Mobile header sizing */
@media (max-width:768px){
  .hero{padding:58px 10px 12px;position:relative;}
  .hero-inner{gap:12px;justify-content:center;flex-wrap:nowrap;padding:0 6px;}
  .logo-wrap{width:68px;height:68px;border-radius:18px;}
  .logo-wrap img{width:48px;max-width:80%;}
  .brand{max-width:78vw;}
  .brand-name{font-size:30px;letter-spacing:3px;line-height:1.05;white-space:normal;word-break:break-word;}
  .brand-sub{font-size:12px;margin-top:6px;letter-spacing:2.2px;}
}

/* SNAPSHOT (ONLY HIGH/LOW) */
/* ✅ CHANGE: Hidden on PC/TV, shown only on mobile */
.snapshot{ display:none; }

@media (max-width:768px){
  .snapshot{
    display:block;
    width:min(1700px, 96vw);
    margin:14px auto 0;
    padding:0 14px;
  }
  .snap-grid{
    display:grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:12px;
  }
  .snap{
    position:relative;
    border-radius:18px;
    border:1px solid rgba(255,211,106,.16);
    background:
      radial-gradient(700px 260px at 18% 18%, rgba(255,211,106,.08), transparent 60%),
      linear-gradient(180deg, rgba(14,18,28,.78), rgba(6,8,14,.78));
    box-shadow:0 12px 34px rgba(0,0,0,.52);
    padding:14px 16px;
    overflow:hidden;
    min-width:0;
  }
  .snap-k{font-size:12px;font-weight:900;letter-spacing:.75px;color:rgba(207,216,255,.88);}
  .snap-v{margin-top:10px;font-size:18px;font-weight:900;letter-spacing:.2px;color:#fff;line-height:1.15;}
}

/* ✅ MOBILE snapshot FIT */
@media (max-width:768px){
  .snapshot{padding:0 10px;}
  .snap-grid{grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px;}
  .snap{padding:12px 12px;border-radius:16px;min-width:0;}
  .snap-k{font-size:11px;letter-spacing:.55px;}
  .snap-v{font-size:14px;line-height:1.2;white-space:normal;}
}
/* very small phones: stack to 1 column */
@media (max-width:420px){
  .snap-grid{grid-template-columns:1fr;}
}

/* ✅ TV FIX (kept; snapshot is already hidden on TV/PC) */
@media (min-width:1200px){
  .snap{min-height:92px;}
  .snap-v{font-size:20px;}
}

/* CHART GRID */
.rates{
  max-width:1700px;
  margin:14px auto 96px;
  padding:14px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
.card{
  position:relative;
  background:
    radial-gradient(900px 420px at 22% 18%, rgba(255,211,106,.09), transparent 58%),
    linear-gradient(180deg, rgba(14,18,28,.92), rgba(6,8,14,.92));
  border:1px solid rgba(255,211,106,.18);
  border-radius:22px;
  overflow:hidden;
  min-height:620px;
  box-shadow:var(--shadow);
}
.card-title{
  padding:12px 14px;
  border-bottom:1px solid rgba(255,211,106,.12);
  background:linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.12));
}
.ct-name{font-size:15px;font-weight:900;letter-spacing:.8px;}
.ct-sub{margin-top:4px;font-size:12px;font-weight:800;letter-spacing:.25px;color:rgba(207,216,255,.85);opacity:.95;}

.tv-box{position:relative;height:calc(100% - 0px)}
.tv-inner{position:absolute;inset:0}
.tv-inner iframe{
  position:absolute!important;
  left:50%!important;top:50%!important;
  transform-origin:center center !important;
  transform:translate(calc(-50% + 80px), calc(-50% + 40px)) scale(1.10)!important;
  width:100%!important;height:100%!important;border:0;
}

.lastbox{
  position:absolute;
  top:14px; left:14px;
  z-index:10;
  min-width:260px;
  padding:14px 16px;
  border-radius:16px;
  border:1px solid rgba(255,211,106,.28);
  background:linear-gradient(180deg, rgba(0,0,0,.80), rgba(0,0,0,.54));
  backdrop-filter: blur(12px);
  box-shadow:0 10px 28px rgba(0,0,0,.55);
  display:none;
}
.lb-title{font-weight:900;letter-spacing:.8px;font-size:12px;color:rgba(255,255,255,.78);}
.lb-price{margin-top:8px;font-weight:900;font-size:28px;color:var(--gold);letter-spacing:.4px;}
.lb-sub{margin-top:6px;font-weight:800;font-size:12px;color:rgba(207,216,255,.85);letter-spacing:.35px;}
.card.is-closed .tv-inner{opacity:0; pointer-events:none;}
.card.is-closed .lastbox{display:block;}

/* MOBILE charts */
@media(max-width:1100px){ .rates{grid-template-columns:1fr} }
@media (max-width:768px){
  .rates{grid-template-columns:1fr;margin:12px auto 86px;padding:10px;gap:12px;}
  .card{min-height:auto;border-radius:20px;}
  .tv-box{height:380px;}
  .tv-inner iframe{transform:translate(-50%,-50%) scale(0.92)!important;}
}

/* FOOTER */
.footerline{
  width:100%;
  position:fixed;
  left:0; right:0;
  bottom:64px;
  height:30px;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:6;
  pointer-events:none;
}
.footerline-inner{
  width:min(1700px, 96vw);
  padding:0 14px;
  display:flex;justify-content:center;gap:12px;align-items:center;
  font-weight:900;
  font-size:12px;
  letter-spacing:.35px;
  color:rgba(255,255,255,.68);
  opacity:.92;
}
@media(max-width:768px){
  .footerline{bottom:54px;height:28px;}
  .footerline-inner{font-size:11px;}
}

/* TICKER */
.ticker{
  position:fixed;bottom:0;left:0;right:0;
  height:64px;
  background:linear-gradient(180deg, rgba(0,0,0,.78), rgba(0,0,0,.62));
  border-top:1px solid rgba(255,179,0,.18);
  overflow:hidden;
  backdrop-filter: blur(12px);
  z-index:5;
}
.ticker::before,.ticker::after{
  content:"";position:absolute;top:0;bottom:0;width:90px;pointer-events:none;z-index:2;
}
.ticker::before{left:0;background:linear-gradient(90deg, rgba(0,0,0,.95), rgba(0,0,0,0));}
.ticker::after{right:0;background:linear-gradient(270deg, rgba(0,0,0,.95), rgba(0,0,0,0));}
.marquee{height:100%;display:flex;align-items:center;overflow:hidden;position:relative;z-index:1;}
.belt{
  display:flex;align-items:center;
  width:max-content;
  will-change:transform;
  transform:translate3d(0,0,0);
  animation:beltMove 70s linear infinite;
}
@keyframes beltMove{0%{transform:translate3d(0,0,0);}100%{transform:translate3d(-50%,0,0);}}
.group{display:flex;align-items:center;gap:42px;white-space:nowrap;padding-left:24px;}
.item{display:flex;align-items:center;gap:12px;font-size:18px;font-weight:800;white-space:nowrap;flex:0 0 auto;}
.badge{
  padding:6px 12px;border-radius:16px;
  background:rgba(255,179,0,.12);
  color:var(--gold3);
  border:1px solid rgba(255,179,0,.26);
  letter-spacing:.35px;
  flex:0 0 auto;
}
.badge.note{background:rgba(207,216,255,.10);border-color:rgba(207,216,255,.20);color:#eaf0ff;}
.sep-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,211,106,.38);box-shadow:0 0 10px rgba(255,211,106,.18);opacity:.9;flex:0 0 auto;}
@media (max-width:768px){
  .ticker{height:54px;}
  .item{font-size:14px;}
  .badge{padding:5px 10px;border-radius:14px;}
}

/* FULLSCREEN button (mobile only) */
.kiosk-btn{
  position:fixed;top:14px;right:14px;z-index:9999;
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;border-radius:999px;
  border:1px solid rgba(255,179,0,.32);
  background:rgba(0,0,0,.46);
  backdrop-filter: blur(12px);
  color:#fff;
  font-family:"ClarityCity",Arial,sans-serif;
  font-weight:900;letter-spacing:.3px;
  cursor:pointer;user-select:none;
  box-shadow:0 0 20px rgba(255,179,0,.10);
}
.kiosk-btn:active{transform:translateY(1px);}
.kiosk-ic{width:12px;height:12px;border-radius:50%;background:rgba(255,211,106,.9);box-shadow:0 0 12px rgba(255,179,0,.55);}
.kiosk-hint{font-size:12px;font-weight:800;opacity:.7;}
@media (min-width:769px){.kiosk-btn{display:none!important;}}
@media (max-width:768px){
  .kiosk-btn{
    display:flex!important;
    position:absolute;
    top:10px;left:10px;right:auto;
    padding:8px 10px;
    gap:8px;
  }
  #kioskLabel{font-size:12px;letter-spacing:.2px;}
  .kiosk-ic{width:10px;height:10px;}
  .kiosk-hint{display:none;}
}

@media (prefers-reduced-motion: reduce){
  .belt{animation:none;}
  .dot{animation:none;}
  body::before{animation:none;}
}
</style>
</head>

<body>

<button class="kiosk-btn" id="kioskBtn" type="button" aria-label="Toggle fullscreen">
  <span class="kiosk-ic" aria-hidden="true"></span>
  <span id="kioskLabel">FULL SCREEN</span>
  <span class="kiosk-hint" id="kioskHint">Fullscreen</span>
</button>

<div class="statusbar">
  <div class="statusbar-inner">
    <div class="sb-left">
      <span class="dot" id="statusDot"></span>
      <span class="sb-title" id="marketLine">--</span>
    </div>
    <div class="sb-clock" id="clock">--</div>
  </div>
</div>

<div class="hero">
  <div class="hero-inner">
    <div class="logo-wrap"><img src="logo.png" alt="Logo"></div>
    <div class="brand">
      <div class="brand-name">SHALUQ JEWELLERS</div>
      <div class="brand-sub">Live Gold &amp; Silver Prices</div>
    </div>
  </div>
</div>

<div class="divider"></div>

<!-- ✅ Snapshot remains in HTML but is ONLY visible on mobile via CSS -->
<div class="snapshot">
  <div class="snap-grid">
    <div class="snap">
      <div class="snap-k">GOLD HIGH / LOW (24H)</div>
      <div class="snap-v" id="goldHL">High/Low: --</div>
    </div>
    <div class="snap">
      <div class="snap-k">SILVER HIGH / LOW (24H)</div>
      <div class="snap-v" id="silverHL">High/Low: --</div>
    </div>
  </div>
</div>

<div class="rates">
  <div class="card" id="goldCard">
    <div class="card-title">
      <div>
        <div class="ct-name">GOLD • XAUUSD</div>
        <div class="ct-sub">USD/oz • OANDA</div>
      </div>
    </div>
    <div class="tv-box">
      <div class="lastbox" id="goldLastBox">
        <div class="lb-title">LAST (CLOSE)</div>
        <div class="lb-price" id="goldLast">--</div>
        <div class="lb-sub" id="goldLastTime">Saved: --</div>
      </div>
      <div class="tv-inner"><div id="gold"></div></div>
    </div>
  </div>

  <div class="card" id="silverCard">
    <div class="card-title">
      <div>
        <div class="ct-name">SILVER • XAGUSD</div>
        <div class="ct-sub">USD/oz • OANDA</div>
      </div>
    </div>
    <div class="tv-box">
      <div class="lastbox" id="silverLastBox">
        <div class="lb-title">LAST (CLOSE)</div>
        <div class="lb-price" id="silverLast">--</div>
        <div class="lb-sub" id="silverLastTime">Saved: --</div>
      </div>
      <div class="tv-inner"><div id="silver"></div></div>
    </div>
  </div>
</div>

<div class="footerline" aria-hidden="true">
  <div class="footerline-inner">
    <span>© SHALUQ JEWELLERS • Dubai • Fujairah</span>
  </div>
</div>

<div class="ticker">
  <div class="marquee" aria-label="Contact information ticker">
    <div class="belt">
      <div class="group">
        <div class="item"><span class="badge">DUBAI</span> Office M02, Saeed Mohammed Building, Deira Gold Souk Dubai</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">FOR DUBAI CALL</span> +971 54 786 9940</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">VISIT</span> www.shaluqjewellers.com</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">FUJAIRAH</span> Hamad Bin Abdulla Rd, Merashid, Opposite ADCB Bank Fujairah UAE</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">FOR FUJAIRAH CALL</span> +971 92 439 539</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">SHALUQ JEWELLERS</span> Where Luxury Meets Affection</div>

        <div class="item"><span class="sep-dot"></span><span class="badge note">NOTE</span> Prices are indicative • Confirm before invoice</div>
        <div class="item"><span class="sep-dot"></span><span class="badge note">UPDATE</span> High/Low refreshes every 60s when market is open</div>
      </div>

      <div class="group" aria-hidden="true">
        <div class="item"><span class="badge">DUBAI</span> Office M02, Saeed Mohammed Building, Deira Gold Souk Dubai</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">FOR DUBAI CALL</span> +971 54 786 9940</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">VISIT</span> www.shaluqjewellers.com</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">FUJAIRAH</span> Hamad Bin Abdulla Rd, Merashid, Opposite ADCB Bank Fujairah UAE</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">FOR FUJAIRAH CALL</span> +971 92 439 539</div>
        <div class="item"><span class="sep-dot"></span><span class="badge">SHALUQ JEWELLERS</span> Where Luxury Meets Affection</div>

        <div class="item"><span class="sep-dot"></span><span class="badge note">NOTE</span> Prices are indicative • Confirm before invoice</div>
        <div class="item"><span class="sep-dot"></span><span class="badge note">UPDATE</span> High/Low refreshes every 60s when market is open</div>
      </div>
    </div>
  </div>
</div>

<script>
/* TradingView widgets */
function addTV(symbol,id){
  const s=document.createElement("script");
  s.src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-info.js";
  s.async=true;
  s.innerHTML=JSON.stringify({symbol:symbol,colorTheme:"dark",isTransparent:true,locale:"en"});
  document.getElementById(id).appendChild(s);
}
addTV("OANDA:XAUUSD","gold");
addTV("OANDA:XAGUSD","silver");

/* Dubai time helpers */
function getDubaiDate(){
  const now=new Date();
  const utc=now.getTime() + (now.getTimezoneOffset()*60000);
  return new Date(utc + (4*60*60000));
}
function formatAMPM(dateObj){
  let h=dateObj.getHours();
  const m=String(dateObj.getMinutes()).padStart(2,"0");
  const ampm=h>=12?"PM":"AM";
  h=h%12; if(h===0) h=12;
  return `${h}:${m} ${ampm}`;
}

/* World clock line */
function tickClock(){
  const now=new Date();
  const d=getDubaiDate();
  const uae=formatAMPM(d);
  const ny=new Date(now.toLocaleString("en-US",{timeZone:"America/New_York"}));
  const usa=formatAMPM(ny);
  const lon=new Date(now.toLocaleString("en-GB",{timeZone:"Europe/London"}));
  const ldn=formatAMPM(lon);
  document.getElementById("clock").textContent = `${uae} UAE • ${usa} USA • ${ldn} LON`;
}
tickClock();
setInterval(tickClock, 10000);

/* ===== GoldAPI (HIGH/LOW + store LAST CLOSE) ===== */
const API_KEY="goldapi-16u3bfsmlexowde-io";
const LS_KEY="shal_uq_last_prices_v1";
let pricePollTimer=null;
let lastMarketState=null;
let marketCountdownTimer=null;

function loadSaved(){
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveSaved(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

function fmt(n){ return n.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2}); }
function fmtSavedTime(ts){
  if (!ts) return "--";
  const d=new Date(ts);
  const dubai = new Date(d.toLocaleString("en-US",{timeZone:"Asia/Dubai"}));
  return `${dubai.toLocaleDateString("en-GB")} ${formatAMPM(dubai)} UAE`;
}
async function fetchWithTimeout(url, options, timeoutMs=9000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { ...options, signal: controller.signal });
    return res;
  } finally {
    clearTimeout(t);
  }
}
async function fetchSpotFull(metal){
  const url = `https://www.goldapi.io/api/${metal}/USD`;
  const res = await fetchWithTimeout(url, {
    cache:"no-store",
    headers:{ "x-access-token": API_KEY }
  }, 9000);
  if(!res.ok) throw new Error("API " + res.status);
  const data = await res.json();

  const price = (data.price ?? data.bid ?? data.ask);
  if(typeof price!=="number") throw new Error("Bad payload");

  const high = (data.high_price ?? data.high ?? data.high_24h ?? null);
  const low  = (data.low_price  ?? data.low  ?? data.low_24h  ?? null);

  return { price, high:(typeof high==="number"?high:null), low:(typeof low==="number"?low:null) };
}

function setOverlay(metal, price, ts){
  if (metal==="XAU"){
    document.getElementById("goldLast").textContent = (typeof price==="number") ? fmt(price) : "--";
    document.getElementById("goldLastTime").textContent = `Saved: ${fmtSavedTime(ts)}`;
  } else {
    document.getElementById("silverLast").textContent = (typeof price==="number") ? fmt(price) : "--";
    document.getElementById("silverLastTime").textContent = `Saved: ${fmtSavedTime(ts)}`;
  }
}

function setHighLow(xau, xag){
  document.getElementById("goldHL").textContent =
    (typeof xau?.high==="number" && typeof xau?.low==="number")
      ? `High/Low: ${fmt(xau.high)} / ${fmt(xau.low)}`
      : "High/Low: --";

  document.getElementById("silverHL").textContent =
    (typeof xag?.high==="number" && typeof xag?.low==="number")
      ? `High/Low: ${fmt(xag.high)} / ${fmt(xag.low)}`
      : "High/Low: --";
}

function showCachedFallback(){
  const saved=loadSaved();
  setHighLow(saved.xau_meta || null, saved.xag_meta || null);
}

async function captureOnce(){
  const [xau,xag]=await Promise.all([fetchSpotFull("XAU"), fetchSpotFull("XAG")]);

  const saved=loadSaved();
  saved.xau=xau.price;
  saved.xag=xag.price;
  saved.xau_meta=xau;
  saved.xag_meta=xag;
  saved.ts=Date.now();
  saveSaved(saved);

  setOverlay("XAU", xau.price, saved.ts);
  setOverlay("XAG", xag.price, saved.ts);
  setHighLow(xau, xag);
}

function startPolling(){
  if(pricePollTimer) return;
  captureOnce().catch(()=>showCachedFallback());
  pricePollTimer=setInterval(()=>{ captureOnce().catch(()=>showCachedFallback()); }, 60000);
}
function stopPolling(){
  if(!pricePollTimer) return;
  clearInterval(pricePollTimer);
  pricePollTimer=null;
}

function applyClosedUI(isOpen){
  const goldCard=document.getElementById("goldCard");
  const silverCard=document.getElementById("silverCard");
  const isClosed=!isOpen;

  goldCard.classList.toggle("is-closed", isClosed);
  silverCard.classList.toggle("is-closed", isClosed);

  const saved=loadSaved();
  if(isClosed){
    setOverlay("XAU", (typeof saved.xau==="number"?saved.xau:null), saved.ts);
    setOverlay("XAG", (typeof saved.xag==="number"?saved.xag:null), saved.ts);
  }
  setHighLow(saved.xau_meta || null, saved.xag_meta || null);
}

/* Market line with seconds */
function updateDubaiMarket(){
  const d=getDubaiDate();
  const day=d.getDay();
  const h=d.getHours();

  const dailyGapClosed=(h===2);
  const weekendClosed=(day===6 && (h>=2)) || (day===0 && (h<3));
  const isOpen=!(dailyGapClosed || weekendClosed);

  const dot=document.getElementById("statusDot");
  const marketLine=document.getElementById("marketLine");

  function getNextClose(nowDubai){
    const close=new Date(nowDubai);
    close.setMilliseconds(0);
    if (nowDubai.getHours()<2) close.setHours(2,0,0,0);
    else { close.setDate(close.getDate()+1); close.setHours(2,0,0,0); }
    return close;
  }
  function getNextOpen(nowDubai){
    const open=new Date(nowDubai);
    open.setMilliseconds(0);
    if (weekendClosed){
      if (day===6){ open.setDate(open.getDate()+1); open.setHours(3,0,0,0); }
      else open.setHours(3,0,0,0);
    } else {
      open.setHours(3,0,0,0);
    }
    return open;
  }

  if (marketCountdownTimer) clearInterval(marketCountdownTimer);

  if (isOpen){
    dot.style.background="var(--open)";
    dot.style.boxShadow="0 0 16px var(--open)";
    const closeAt=getNextClose(d);

    const tick=()=>{
      const nowDubai=getDubaiDate();
      let diff=Math.max(0, Math.floor((closeAt.getTime()-nowDubai.getTime())/1000));
      const hrs=Math.floor(diff/3600); diff%=3600;
      const mins=Math.floor(diff/60); diff%=60;
      const secs=diff;
      marketLine.textContent=`Market Open • Closes in ${hrs}h ${mins}m ${String(secs).padStart(2,"0")}s`;
    };
    tick();
    marketCountdownTimer=setInterval(tick, 1000);
  } else {
    dot.style.background="var(--closed)";
    dot.style.boxShadow="0 0 16px var(--closed)";
    const openAt=getNextOpen(d);

    const tick=()=>{
      const nowDubai=getDubaiDate();
      let diff=Math.max(0, Math.floor((openAt.getTime()-nowDubai.getTime())/1000));
      const days=Math.floor(diff/86400); diff%=86400;
      const hrs=Math.floor(diff/3600); diff%=3600;
      const mins=Math.floor(diff/60); diff%=60;
      const secs=diff;

      marketLine.textContent = (days>0)
        ? `Market Closed • Opens in ${days}d ${hrs}h ${mins}m ${String(secs).padStart(2,"0")}s`
        : `Market Closed • Opens in ${hrs}h ${mins}m ${String(secs).padStart(2,"0")}s`;
    };
    tick();
    marketCountdownTimer=setInterval(tick, 1000);
  }

  if (lastMarketState===null || lastMarketState!==isOpen){
    lastMarketState=isOpen;
    if (isOpen){
      applyClosedUI(true);
      startPolling();
    } else {
      captureOnce().catch(()=>showCachedFallback());
      stopPolling();
      applyClosedUI(false);
    }
  }
}
updateDubaiMarket();
setInterval(updateDubaiMarket, 30000);

/* Load last saved on first paint */
(function initSaved(){
  const saved=loadSaved();
  setOverlay("XAU", (typeof saved.xau==="number"?saved.xau:null), saved.ts);
  setOverlay("XAG", (typeof saved.xag==="number"?saved.xag:null), saved.ts);
  setHighLow(saved.xau_meta || null, saved.xag_meta || null);
})();

/* Fullscreen (mobile) */
const kioskBtn=document.getElementById("kioskBtn");
const kioskLabel=document.getElementById("kioskLabel");
const kioskHint=document.getElementById("kioskHint");
function isFullscreen(){return !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement);}
async function enterFullscreen(){
  const el=document.documentElement;
  if (el.requestFullscreen) return el.requestFullscreen();
  if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
  if (el.msRequestFullscreen) return el.msRequestFullscreen();
  throw new Error("Fullscreen not supported");
}
async function exitFullscreen(){
  if (document.exitFullscreen) return document.exitFullscreen();
  if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
  if (document.msExitFullscreen) return document.msFullscreenElement ? document.msExitFullscreen() : null;
}
async function toggleKiosk(){
  try{
    if (!isFullscreen()){
      await enterFullscreen();
      kioskHint.textContent="Tap EXIT to close";
      setTimeout(()=> kioskHint.textContent="Fullscreen", 1500);
    } else {
      await exitFullscreen();
    }
    kioskLabel.textContent=isFullscreen()?"EXIT":"FULL SCREEN";
  }catch(err){
    kioskHint.textContent="Blocked";
    setTimeout(()=> kioskHint.textContent=isFullscreen()?"Exit":"Fullscreen", 1500);
  }
}
kioskBtn.addEventListener("click", toggleKiosk);
["fullscreenchange","webkitfullscreenchange","msfullscreenchange"].forEach(ev=>{
  document.addEventListener(ev, ()=> kioskLabel.textContent=isFullscreen()?"EXIT":"FULL SCREEN");
});
kioskLabel.textContent=isFullscreen()?"EXIT":"FULL SCREEN";
</script>

</body>
</html>
